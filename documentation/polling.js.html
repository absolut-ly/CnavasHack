<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: polling.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: polling.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Checks a .csv db and polls each domain for server status, updates db and sends msgs to discord webhook on status change
 */
const polling = (() => {
  const msg = require('./msgModule');
  const fetch = require('node-fetch');
  const fs = require('fs');
  const csv = require('csv-parser');
  const _whurl = "https://discord.com/api/webhooks/817140114680971306/X2GzQqA-Sonr1tM1-yAd-43fkuxKBGBWn0a-OIL8AE1okq6H3sPEqgGKRJvX7vCTQWEY";
  let statusChange;
  let newStatus;

  //opens the csv file with domain info and calls checkStatus() to check each row.
  fs.createReadStream('data.csv')
    .pipe(csv())
    .on('data', (row) => {
      let domain = row.DomainURL;
      let status = row.Status;
      let name = row.Username;
      let avatar = row.Avatar_url;
      checkStatus(domain, status, name, avatar);
      if (statusChange) {
        //write newStatus to the status cell of the current row.

      }
    });

  /**
   * Sends a get request to domain and calls msg.send() on status change
   * @param {*} domainUrl Domain url to check in the get request 
   * @param {*} status Old domain status from database
   * @param {*} username Display name for discord bot
   * @param {*} avatar_url Display avatar for discord bot
   */
  const checkStatus = (domainUrl, status, username, avatar_url) => {
    let currentStatus = status;
    statusChange = false;
    fetch(domainUrl)
      // Update to use authentication and more robust res data.
      .then(res => res.ok)
      .then(bool => {
        if (currentStatus === 'Up' &amp;&amp; !bool) {
          msg.send(_whurl, 'Server is down.', username, avatar_url);
          statusChange = true;
          newStatus = 'Down';
        }
        if (currentStatus === 'Down' &amp;&amp; bool) {
          msg.send(_whurl, 'Server is up.', username, avatar_url);
          statusChange = true;
          newStatus = 'Up';
        }
      });
  }

})();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#msgModule">msgModule</a></li><li><a href="global.html#polling">polling</a></li><li><a href="global.html#scrape">scrape</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Thu Mar 11 2021 22:03:35 GMT-0500 (Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
